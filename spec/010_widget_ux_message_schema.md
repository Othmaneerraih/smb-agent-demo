# 010 — Widget UX + Message Schema Specification

## Scope
This spec defines the outbound message contract and widget rendering behavior for:

**Chatwoot web widget on WooCommerce WordPress + AI Agent Service behind it**.

This document is authoritative for structured outbound responses generated by the Agent Service and posted to Chatwoot.

---

## 1) Supported Outbound Message Types

The Agent Service MUST emit one of the following outbound `type` values:

1. `text`
2. `product_cards`
3. `quick_replies`
4. `error`
5. `handoff`

No additional type is allowed unless this spec is updated.

---

## 2) Envelope Schema (Common Wrapper)

All outbound responses MUST use the following envelope:

```json
{
  "type": "text | product_cards | quick_replies | error | handoff",
  "message_id": "string",
  "conversation_id": "string",
  "timestamp": "ISO-8601 string",
  "payload": {},
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required fields
- `type` (string enum)
- `message_id` (string; unique per message)
- `conversation_id` (string)
- `timestamp` (string; ISO-8601)
- `payload` (object; shape depends on `type`)

### Optional fields
- `meta` (object)
  - `source` (string)
  - `schema_version` (string)
  - `trace_id` (string)
  - `locale` (string, e.g., `en-US`)

---

## 3) Type Schemas

## 3.1 `text`

### JSON schema
```json
{
  "type": "text",
  "message_id": "msg_123",
  "conversation_id": "conv_123",
  "timestamp": "2026-01-01T10:00:00Z",
  "payload": {
    "text": "string"
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required payload fields
- `text` (string; non-empty)

### Optional payload fields
- `markdown` (boolean; default `false`)

---

## 3.2 `product_cards`

### JSON schema
```json
{
  "type": "product_cards",
  "message_id": "msg_124",
  "conversation_id": "conv_123",
  "timestamp": "2026-01-01T10:00:01Z",
  "payload": {
    "summary_text": "Here are 3 options that match your request.",
    "cards": [
      {
        "id": "prod_001",
        "image": "https://example.com/image.jpg",
        "title": "UltraSoft Cotton Tee",
        "price": 19.99,
        "currency": "USD",
        "stock_status": "in_stock",
        "key_attributes": [
          { "name": "Material", "value": "100% Cotton" },
          { "name": "Fit", "value": "Regular" }
        ],
        "product_url": "https://shop.example.com/products/ultrasoft-cotton-tee",
        "cta_buttons": [
          {
            "label": "View Product",
            "value": "open_product:prod_001",
            "action": "open_url",
            "url": "https://shop.example.com/products/ultrasoft-cotton-tee"
          }
        ]
      }
    ]
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required payload fields
- `cards` (array; length >= 1)

### Optional payload fields
- `summary_text` (string)

### Required fields for each product card
- `id` (string)
- `image` (string URL)
- `title` (string)
- `price` (number)
- `currency` (string; ISO 4217 preferred)
- `stock_status` (enum: `in_stock`, `low_stock`, `out_of_stock`, `preorder`)
- `key_attributes` (array of `{ name: string, value: string }`, length >= 1)
- `product_url` (string URL)

### Optional fields for each product card
- `description` (string)
- `cta_buttons` (array; length >= 0)
  - button object:
    - required: `label`, `value`, `action`
    - optional: `url` (required when `action = open_url`)
    - `action` enum: `postback`, `open_url`

### Validation rules
- `price` MUST be >= 0.
- `image` and `product_url` MUST be valid absolute URLs.
- `cta_buttons[].label` MUST be user-friendly text.

---

## 3.3 `quick_replies`

### JSON schema
```json
{
  "type": "quick_replies",
  "message_id": "msg_125",
  "conversation_id": "conv_123",
  "timestamp": "2026-01-01T10:00:02Z",
  "payload": {
    "prompt": "Would you like to see more options?",
    "replies": [
      {
        "label": "Yes",
        "value": "yes_show_more",
        "meaning": "yes"
      },
      {
        "label": "No",
        "value": "no_thanks",
        "meaning": "no"
      }
    ]
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required payload fields
- `prompt` (string; non-empty)
- `replies` (array; length >= 1)

### Required fields for each reply
- `label` (string; button text)
- `value` (string; machine-readable value)
- `meaning` (enum):
  - `confirm`
  - `cancel`
  - `yes`
  - `no`
  - `show_more`
  - `filter`

### Optional fields for each reply
- `description` (string)

### Validation rules
- `label` MUST be concise (recommended <= 24 chars).
- `value` MUST be stable for downstream parsing.
- `meaning` MUST accurately represent the user intent category.

---

## 3.4 `error`

### JSON schema
```json
{
  "type": "error",
  "message_id": "msg_126",
  "conversation_id": "conv_123",
  "timestamp": "2026-01-01T10:00:03Z",
  "payload": {
    "code": "PRODUCT_INDEX_UNAVAILABLE",
    "message": "I’m having trouble retrieving products right now.",
    "retryable": true,
    "suggested_next_step": "Please try again in a moment."
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required payload fields
- `code` (string)
- `message` (string; user-safe)
- `retryable` (boolean)

### Optional payload fields
- `suggested_next_step` (string)
- `details` (object; non-sensitive diagnostics)

---

## 3.5 `handoff`

### JSON schema
```json
{
  "type": "handoff",
  "message_id": "msg_127",
  "conversation_id": "conv_123",
  "timestamp": "2026-01-01T10:00:04Z",
  "payload": {
    "reason": "user_requested_human",
    "message": "I’m connecting you to a human agent now.",
    "queue": "sales_support",
    "priority": "normal"
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

### Required payload fields
- `reason` (enum):
  - `user_requested_human`
  - `policy_restricted`
  - `low_confidence`
  - `system_failure`
- `message` (string; user-facing handoff statement)

### Optional payload fields
- `queue` (string)
- `priority` (enum: `low`, `normal`, `high`)
- `context_summary` (string)

---

## 4) Rendering Rules in Chatwoot

## 4.1 General principle
- Prefer **native Chatwoot interactive format** when supported by the target Chatwoot version/channel.
- If native interactive rendering is unavailable, output MUST fall back to a format that is still:
  1. clickable, and
  2. readable.

## 4.2 `text`
- Render as standard Chatwoot text message.

## 4.3 `product_cards`
### Preferred (native interactive)
- Render each card with image preview, title, price + currency, stock status, key attributes, and CTA button(s).

### Fallback (clickable/readable)
- Render a compact numbered list in markdown/plain text using absolute URLs:

```text
1) UltraSoft Cotton Tee — USD 19.99 (in_stock)
   Material: 100% Cotton; Fit: Regular
   View: https://shop.example.com/products/ultrasoft-cotton-tee
```

- Include each CTA as a full clickable URL line where possible.

## 4.4 `quick_replies`
### Preferred (native interactive)
- Render as clickable quick reply buttons/chips.

### Fallback (clickable/readable)
- Render prompt + numbered options; each option maps to a value token the user can click/select/send.

```text
Would you like to see more options?
[1] Yes (yes_show_more)
[2] No (no_thanks)
```

- If clickable chips are unavailable, values must still be clearly visible and parseable.

## 4.5 `error`
- Render as user-safe text, optionally followed by retry guidance.
- Never expose secrets, stack traces, or internal endpoints.

## 4.6 `handoff`
- Render as a clear transition message.
- Preserve queue/priority metadata for backend routing even if not shown to user.

---

## 5) Acceptance Tests (Exact Expected Structured Outputs)

The following examples are normative. Output objects shown below are the exact expected shapes and keys.

## Test A — Product recommendation request

### User query
"Show me running shoes under $100"

### Expected output
```json
{
  "type": "product_cards",
  "message_id": "msg_test_a_001",
  "conversation_id": "conv_test_a",
  "timestamp": "2026-01-01T10:10:00Z",
  "payload": {
    "summary_text": "Here are options under $100.",
    "cards": [
      {
        "id": "sku_run_001",
        "image": "https://shop.example.com/images/sku_run_001.jpg",
        "title": "RunLite 2",
        "price": 89.0,
        "currency": "USD",
        "stock_status": "in_stock",
        "key_attributes": [
          { "name": "Size Range", "value": "US 7-12" },
          { "name": "Weight", "value": "240g" }
        ],
        "product_url": "https://shop.example.com/products/runlite-2",
        "cta_buttons": [
          {
            "label": "View Product",
            "value": "open_product:sku_run_001",
            "action": "open_url",
            "url": "https://shop.example.com/products/runlite-2"
          }
        ]
      }
    ]
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

## Test B — Confirmation prompt

### User query
"Add this to my shortlist"

### Expected output
```json
{
  "type": "quick_replies",
  "message_id": "msg_test_b_001",
  "conversation_id": "conv_test_b",
  "timestamp": "2026-01-01T10:11:00Z",
  "payload": {
    "prompt": "Confirm adding RunLite 2 to your shortlist?",
    "replies": [
      {
        "label": "Confirm",
        "value": "shortlist_confirm",
        "meaning": "confirm"
      },
      {
        "label": "Cancel",
        "value": "shortlist_cancel",
        "meaning": "cancel"
      }
    ]
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

## Test C — Show more options

### User query
"Show me more"

### Expected output
```json
{
  "type": "quick_replies",
  "message_id": "msg_test_c_001",
  "conversation_id": "conv_test_c",
  "timestamp": "2026-01-01T10:12:00Z",
  "payload": {
    "prompt": "Want to refine by brand or price?",
    "replies": [
      {
        "label": "Show More",
        "value": "show_more_items",
        "meaning": "show_more"
      },
      {
        "label": "Filter",
        "value": "open_filter_options",
        "meaning": "filter"
      }
    ]
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

## Test D — Recoverable system error

### User query
"Find me blue jackets"

### Expected output
```json
{
  "type": "error",
  "message_id": "msg_test_d_001",
  "conversation_id": "conv_test_d",
  "timestamp": "2026-01-01T10:13:00Z",
  "payload": {
    "code": "LOCAL_INDEX_TIMEOUT",
    "message": "I’m having trouble searching products right now.",
    "retryable": true,
    "suggested_next_step": "Please retry in a moment."
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

## Test E — Human handoff

### User query
"I want to talk to a person"

### Expected output
```json
{
  "type": "handoff",
  "message_id": "msg_test_e_001",
  "conversation_id": "conv_test_e",
  "timestamp": "2026-01-01T10:14:00Z",
  "payload": {
    "reason": "user_requested_human",
    "message": "I’m connecting you to a human agent now.",
    "queue": "sales_support",
    "priority": "normal"
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

## Test F — Plain informational response

### User query
"What is your return window?"

### Expected output
```json
{
  "type": "text",
  "message_id": "msg_test_f_001",
  "conversation_id": "conv_test_f",
  "timestamp": "2026-01-01T10:15:00Z",
  "payload": {
    "text": "Our standard return window is 30 days from delivery."
  },
  "meta": {
    "source": "agent_service",
    "schema_version": "1.0"
  }
}
```

---

## 6) Compliance Notes
- Agent Service implementations MUST validate outbound payloads against this spec before sending to Chatwoot.
- For product discovery and card construction, data MUST come from the local product index, not synchronous WooCommerce API calls.
- Confirmation flows SHOULD prefer `quick_replies` over free-form prompts.
